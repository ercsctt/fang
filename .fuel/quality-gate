#!/usr/bin/env bash

# Quality gate script for fang project
# Auto-generated based on detected tools in the project
# Runs formatters first, then linters/type-checkers, then tests

set -e  # Exit on first error

echo "ğŸš€ Running quality gate checks..."
echo ""

# Track overall status
FAILED=0

# ============================================================================
# FORMATTERS (Auto-fix code style)
# ============================================================================

echo "ğŸ“ Step 1/5: Running PHP formatter (Pint)..."
if vendor/bin/pint --dirty; then
    echo "âœ… Pint formatting complete"
else
    echo "âŒ Pint formatting failed"
    FAILED=1
fi
echo ""

echo "ğŸ“ Step 2/5: Running JS/TS/Vue formatter (Prettier)..."
if npm run format --silent; then
    echo "âœ… Prettier formatting complete"
else
    echo "âŒ Prettier formatting failed"
    FAILED=1
fi
echo ""

# ============================================================================
# LINTERS & TYPE CHECKERS
# ============================================================================

echo "ğŸ” Step 3/5: Running ESLint..."
if npm run lint --silent; then
    echo "âœ… ESLint checks passed"
else
    echo "âŒ ESLint checks failed"
    FAILED=1
fi
echo ""

echo "ğŸ” Step 4/5: Running TypeScript type checking..."
if npx vue-tsc --noEmit; then
    echo "âœ… TypeScript type checking passed"
else
    echo "âŒ TypeScript type checking failed"
    FAILED=1
fi
echo ""

# ============================================================================
# TESTS
# ============================================================================

echo "ğŸ§ª Step 5/5: Running tests (Pest/PHPUnit)..."
if php artisan test; then
    echo "âœ… All tests passed"
else
    echo "âŒ Tests failed"
    FAILED=1
fi
echo ""

# ============================================================================
# SUMMARY
# ============================================================================

if [ $FAILED -eq 0 ]; then
    echo "âœ… All quality checks passed!"
    exit 0
else
    echo "âŒ Some quality checks failed. Please fix the issues above."
    exit 1
fi
