#!/usr/bin/env bash
set -e

# Quality Gate Script
# Runs formatters, linters, type-checkers, and tests for this project
#
# Usage:
#   .fuel/quality-gate           # Run all checks including full test suite
#   .fuel/quality-gate --fast    # Run only fast checks (for pre-commit)

FAST_MODE=false
if [ "$1" = "--fast" ]; then
    FAST_MODE=true
fi

echo "ğŸ”§ Running quality checks..."
if [ "$FAST_MODE" = true ]; then
    echo "âš¡ Fast mode enabled (pre-commit)"
fi
echo ""

# 1. FORMATTERS (run first to auto-fix style issues)
echo "ğŸ“ Running formatters..."

# Laravel Pint (PHP formatter)
if [ -f "vendor/bin/pint" ]; then
    echo "  â†’ Running Laravel Pint..."
    vendor/bin/pint --dirty
else
    echo "  âš ï¸  Pint not found, skipping PHP formatting"
fi

# Prettier (JS/TS/Vue formatter)
if [ -f "node_modules/.bin/prettier" ]; then
    echo "  â†’ Running Prettier..."
    npm run format 2>/dev/null || npx prettier --write resources/
else
    echo "  âš ï¸  Prettier not found, skipping JS/TS formatting"
fi

echo ""

# 2. LINTERS (check code quality)
echo "ğŸ” Running linters..."

# ESLint (JS/TS/Vue linter)
if [ -f "node_modules/.bin/eslint" ]; then
    echo "  â†’ Running ESLint..."
    npm run lint 2>/dev/null || npx eslint . --fix
else
    echo "  âš ï¸  ESLint not found, skipping JS/TS linting"
fi

echo ""

# 3. TYPE CHECKERS (ensure type safety)
echo "ğŸ”¬ Running type checkers..."

# TypeScript (vue-tsc)
if [ -f "node_modules/.bin/vue-tsc" ]; then
    echo "  â†’ Running TypeScript type checker..."
    npx vue-tsc --noEmit
else
    echo "  âš ï¸  TypeScript not found, skipping type checking"
fi

echo ""

# 4. TESTS
echo "ğŸ§ª Running tests..."

# Pest/PHPUnit tests
if [ -f "vendor/bin/pest" ]; then
    if [ "$FAST_MODE" = true ]; then
        echo "  â†’ Running fast tests only (pre-commit)..."
        # Run only unit tests for speed in pre-commit hook
        # Full test suite should run in CI
        php artisan test --parallel --compact --testsuite=Unit
    else
        echo "  â†’ Running full test suite..."
        php artisan test --parallel --compact
    fi
elif [ -f "vendor/bin/phpunit" ]; then
    echo "  â†’ Running PHPUnit tests..."
    vendor/bin/phpunit
else
    echo "  âš ï¸  No test runner found, skipping tests"
fi

echo ""
echo "âœ… All quality checks passed!"
